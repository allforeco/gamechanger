  {% extends "base_generic.html" %}

{% block title %}
      <title>Reports {{ this_location.name }} - Gamechanger Action Tracker</title>
{% endblock %}

{% block content %}
  <style>
    tbody{
      background-color: #efefef;
      border:1px solid #ffffff;
    }

    td{
      padding-left: 4px;
      padding-bottom: 4px;
      padding-right: 8px;
      
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.full.js"></script>
  
  <h1>
    {{ this_location.name }} 
  </h1>
  <form action="" method="post">
    {% csrf_token %}
    <div class="favoriteform" style="white-space:nowrap; display:inline-block;">
      {% if favorite_location == 'True' %}
        <input type="submit" name="favorite" id="favorite" value="Remove from Favorites" style="color:red; display: inline-block;"/>
      {% else %}
        <input type="submit" name="favorite" id="favorite" value="Add to Favorites" style="color:green; display: inline-block;"/>
        
      {% endif %}
    </div>
  </form>
  <p>
    {% if parent_location %} in 
      <a href="{% url 'action:geo_view' parent_location.id %}">{{ parent_location.name }}</a>
    {% endif %}

  {% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

  {% if sublocation_list %}
    <h2>{{ sublocation_list|length }} locations within {{ this_location.name }}</h2>

    <p>
      {% for sublocation in sublocation_list %}
        <a href="{% url 'action:geo_view' sublocation.id %}">{{ sublocation }}</a> &nbsp;&nbsp;&nbsp; 
      {% endfor %}
    </p>
  {% endif %}

  {% if sublocation_list %}
    <h2>Direct Reports for {{ this_location.name }} in addition to the locations above</h2>
  {% else %}
    <h2>Reports</h2>
  {% endif %}
  {% if witness_list %}
    <p>{{ witness_list|length }} events with a total of {{ total_participants }} reported participants</p>
    <div class="gathering">
      <table>
        <tr>
          <th>Date</th>
          <th>Map ID</th>
          <th>Participants</th>
          <th>Photos</th>
          <th>Host</th>
        </tr>
        {% for witness in witness_list %}
          <tr>
            <td><a href="{% url 'action:geo_update' witness.id %}">{{ witness.date|date:'Y-m-d' }}</a></td>
            <td style="text-align: center;"><a href="https://map.fridaysforfuture.org/?e={{witness.gathering.regid}}">&nbsp;üåê&nbsp;<small style="display: none;">{{ witness.gathering.regid }}</small></a></td>
            <td style="text-align: right;">
              {% if witness.participants %}
                {{ witness.participants }}
              {% else %}
                ?
              {% endif %}
            </td>
            <td>
              {% if witness.proof_url %}
                <a href="{{ witness.proof_url }}">Photo</a>
              {% endif %}
            </td> 
            <td>
              {% if witness.organization %}
                <small>{{ witness.organization }}</small>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </table>
    </div>
  {% else %}
    <p>No results registered yet.</p>
  {% endif %}
  <div>
    <script>
      function togglenewevent(){
        var el = document.getElementById("newevent");
        if (el.style.display != "inline")
          el.style.display = "inline";
        else {
          el.style.display = "none";
        }
      }

      function toggleadvancededit(){
        var el = document.getElementById("advancededit");
        if (el.style.display != "inline")
          el.style.display = "inline";
        else {
          el.style.display = "none";
        }
      }
    </script>
    <br />
    <input type="button" value="New Event" onclick="togglenewevent()">

    <div style="display: none;" id="newevent">
      <form action="" method="post" id="form">
        {% csrf_token %}
        <input type="hidden" id="prev_participants" value="{{ prev_participants }}"/>
        <input type="hidden" id="prev_url" value="{{ prev_url }}"/>
        <script type="text/javascript">
          // For XHTML: <![CDATA[
          function show_unsaved(show) {
            if(show) {
              document.getElementById("save_changes").style.display = "inline-block";
              document.getElementById("form").style.backgroundColor = "#ffeeee";
              document.getElementById("favorite").style.display = "none";
            } else {
              document.getElementById("save_changes").style.display = "none";
              document.getElementById("form").style.backgroundColor = "";
              document.getElementById("favorite").style.display = "inline-block";
            }
          }
          function check_unsaved() {
            if(document.getElementById("prev_participants").value == document.getElementById("participants").value &&
               document.getElementById("prev_url").value == document.getElementById("url").value) {
              show_unsaved(false);
            } else {
              show_unsaved(true);
            }
          }
          // For XHTML: ]]>
        </script>
        <table>
          <tr>
            <td><legend>Participants</legend></td>
            <td><input type="number" id="participants" name="participants" value="{{ prev_participants }}" min="1" max="99999" oninput="check_unsaved()" onchange="check_unsaved()"/></td>
          </tr>
          <tr>
            <td><legend>URL to Photo</legend></td>
            <td><input placeholder="You are welcome to share a photo from the event (optional) that we can show the world!" type="url" id="url" name="url" value="{{ prev_url }}" size="60" oninput="check_unsaved()" onchange="check_unsaved()"/></td>
          </tr>
          <tr>
            <td>Organization (if any)</td>
            <td>
              <select name="organization" data-minimum-input-length="3" id="id_organization" data-autocomplete-light-language="en" data-autocomplete-light-url="/action/organization-autocomplete/" data-autocomplete-light-function="select2">
                <option value="{{ gat_organizations|first }}" selected>{{ gat_organizations|first }}</option>
              </select>
            </td>
            <link href="/static/admin/css/vendor/select2/select2.min.css" type="text/css" media="screen" rel="stylesheet">
            <link href="/static/admin/css/autocomplete.css" type="text/css" media="screen" rel="stylesheet">
            <link href="/static/autocomplete_light/select2.css" type="text/css" media="screen" rel="stylesheet">
            <script src="/static/admin/js/vendor/select2/select2.full.js"></script>
            <script src="/static/autocomplete_light/autocomplete_light.min.js"></script>
            <script src="/static/autocomplete_light/select2.min.js"></script>
            <script src="/static/autocomplete_light/i18n/en.js"></script>
          </tr>
          {% if user.is_authenticated is user.is_authenticated %}
          <tr>
            <td style="white-space:nowrap;">
              <input type="button" value="Advanced Edit" style="display: inline-block; cursor: not-allowed;" onclick="toggleadvancededit()"/>
              <input type="submit" value="Report Result" style="display: inline-block;"/>
            </td>
            <td style="white-space:nowrap;">
              <div style="color:red; display: none;" id="save_changes">&nbsp;&nbsp;&nbsp;‚Ü§&nbsp;&nbsp;Save Your Changes</div>
            </td>
          </tr>
          {% endif %}
        </table>
        {% if True is False %}
          <p style="color:red">Reporting temporarily closed for maintenance. Use this reporting form instead: <a href="https://docs.google.com/forms/d/e/1FAIpQLSeyRjvtBZZAEXUbLDe_P4tTIKncQaGxrkrxUcmmiyaZDdLFtg/viewform">Report!</a></p>
        {% endif %}
      </form>
  </div>
{% endblock %}